{% extends "base/base.html" %}
{% load static %}

{% block title_pag %}Asistente Virtual | PrectictAI ü§ñ{% endblock title_pag %}

{% block css_styles %}
    <link rel="stylesheet" href="{% static 'chatbot/css/chatbot.css' %}">
{% endblock css_styles %}

{% block favicon %}
    data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>
{% endblock favicon %}

{% block content %}
    <body>
        <!-- ‚úÖ CSRF TOKEN PARA ELIMINAR CONVERSACIONES -->
        {% csrf_token %}
        
        <div class="chat-container">
            <!-- üìú SIDEBAR CON HISTORIAL -->
            <div class="chat-sidebar" id="chatSidebar">
                <div class="sidebar-header">
                    <h4>üí¨ Conversaciones</h4>
                    <button class="btn btn-primary btn-sm" onclick="nuevaConversacion()">
                        ‚ûï Nuevo Chat
                    </button>
                </div>
                
                <div class="conversaciones-list">
                    {% for conv in conversaciones %}
                    <a href="#" 
                    data-conversacion-id="{{ conv.id }}"
                    onclick="event.preventDefault(); NavigationManager.loadConversation({{ conv.id }}); return false;"
                    class="conversacion-item {% if conv.id == conversacion_actual.id %}active{% endif %}">
                        <div class="conv-titulo">{{ conv.titulo }}</div>
                        <div class="conv-fecha">{{ conv.fecha_actualizacion|date:"d/m/Y H:i" }}</div>
                        <button class="btn-delete" onclick="eliminarConversacion(event, {{ conv.id }})">üóëÔ∏è</button>
                    </a>
                    {% empty %}
                    <p class="text-muted text-center mt-3">No hay conversaciones</p>
                    {% endfor %}
                </div>
            </div>

            <!-- üí¨ CHAT PRINCIPAL -->
            <div class="chat-fullscreen">
                <div class="chatbot-header">
                <!-- ‚úÖ BOT√ìN TOGGLE SIDEBAR CON DOS √çCONOS -->
                <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Mostrar/Ocultar conversaciones">
                    <!-- √çcono de men√∫ hamburguesa (mostrar sidebar cuando est√° oculto) -->
                    <svg id="menuIcon" class="toggle-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                    <!-- √çcono de X (cerrar sidebar cuando est√° visible) -->
                    <svg id="closeIcon" class="toggle-icon hidden" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>

                    <div class="chatbot-header-info">
                        <div class="chatbot-avatar">AI</div>
                        <div>
                            <h3 class="chatbot-title">{{ conversacion_actual.titulo }}</h3>
                            <div class="chatbot-status">
                                <span class="status-dot"></span>
                                <span>En l√≠nea</span>
                            </div>
                        </div>
                    </div>
                    <a href="{% url 'companies:dashboard' %}" class="chatbot-close" title="Volver al dashboard">‚Üê</a>
                </div>

                <div class="chatbot-messages" id="chatbotMessages">
                    {% if mensajes %}
                        {% for msg in mensajes %}
                            <div class="message {{ msg.tipo }}">
                                <div class="message-content">
                                    {{ msg.mensaje|safe }}
                                    <div class="message-time">{{ msg.fecha|date:"H:i" }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="welcome-message">
                            <h3>¬°Hola! Soy tu asistente</h3>
                            <p>¬øEn qu√© puedo ayudarte hoy?</p>
                            <div class="welcome-suggestions">
                                <div class="suggestion-chip" data-message="¬øCu√°les son los productos m√°s vendidos?">
                                    ¬øCu√°les son los productos m√°s vendidos?
                                </div>
                                <div class="suggestion-chip" data-message="Registrar venta">
                                    Registrar una venta
                                </div>
                                <div class="suggestion-chip" data-message="¬øQu√© productos necesito reponer?">
                                    ¬øQu√© productos necesito reponer?
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- ‚å®Ô∏è INPUT + MIC + ENVIAR -->
                <div class="chatbot-input-area">
                    <input 
                        type="text" 
                        class="chatbot-input" 
                        id="chatbotInput" 
                        placeholder="Escribe tu mensaje..."
                        autocomplete="off"
                    >

                    <!-- üé§ BOT√ìN MICR√ìFONO -->
                    <button class="chatbot-mic-btn" id="chatbotMic" type="button">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                    </button>

                    <!-- üì§ BOT√ìN ENVIAR -->
                    <button class="chatbot-send-btn" id="chatbotSend">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- ‚úÖ MODAL DE CONFIRMACI√ìN -->
        <div id="confirmModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon warning">
                        <span>‚ö†Ô∏è</span>
                    </div>
                    <h3 class="modal-title" id="modalTitle">Confirmar acci√≥n</h3>
                </div>
                <div class="modal-body" id="modalMessage">
                    ¬øEst√°s seguro de realizar esta acci√≥n?
                </div>
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-cancel" id="modalCancel">Cancelar</button>
                    <button class="modal-btn modal-btn-confirm" id="modalConfirm">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- ‚úÖ CONTENEDOR DE NOTIFICACIONES -->
        <div class="notification-container" id="notificationContainer"></div>

        {% block js_scripts %}
            <script>
                window.CONVERSACION_ID = {{ conversacion_actual.id }};
            </script>
            <script src="{% static 'chatbot/js/chatbot.js' %}"></script>
        {% endblock js_scripts %}
    </body>
{% endblock content %}
