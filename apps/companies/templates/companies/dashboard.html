{% extends "base/base.html" %}
{% load static %}

{% block title_pag %}PredictAI | Dashboard üíª{% endblock title_pag %}
{% block favicon %}
    https://cdn-icons-png.flaticon.com/512/2900/2900103.png
{% endblock favicon %}

{% block css_styles %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'companies/css/dashboard.css' %}">

    <style>
        .chatbot-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: all 0.3s ease;
        }

        .chatbot-button:hover {
            transform: scale(1.1);
        }

        .chatbot-button svg {
            width: 28px;
            height: 28px;
            fill: white;
        }
    </style>
{% endblock css_styles %}

{% block content %}
    <body>
        <!-- NAVBAR -->
        <nav class="navbar">
            <div class="container-fluid px-4">
                <span class="navbar-brand">PredictAI</span>
                <span class="text-white-50 d-none d-md-inline">Dashboard Inteligente</span>
            </div>
        </nav>

        <div class="container-fluid px-3 px-md-4 py-4">
            <!-- M√âTRICAS PRINCIPALES -->
            <div class="row mb-4 fade-in-sequence">
                <div class="col-12 col-sm-6 col-lg-3 mb-3 mb-lg-0">
                    <div class="metric-card">
                        <div class="metric-label">Ventas Hoy</div>
                        <div class="metric-value ventas-hoy">${{ ventas_hoy|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3 mb-lg-0">
                    <div class="metric-card">
                        <div class="metric-label">Ventas del Mes</div>
                        <div class="metric-value ventas-mes">${{ ventas_mes|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3 mb-lg-0">
                    <div class="metric-card">
                        <div class="metric-label">Ganancia del Mes</div>
                        <div class="metric-value text-success ganancia-mes">${{ ganancia_mes|floatformat:2 }}</div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-3 mb-3 mb-lg-0">
                    <div class="metric-card">
                        <div class="metric-label">Productos a Reponer</div>
                        <div class="metric-value productos-reponer" style="color: var(--danger);">{{ productos_reponer|length }}</div>
                    </div>
                </div>
            </div>

            <!-- GR√ÅFICO Y TOP PRODUCTOS -->
            <div class="row mb-4">
                <div class="col-12 col-lg-6 mb-4 mb-lg-0">
                    <div class="chart-container">
                        <h5>Ventas √öltimos 7 D√≠as</h5>
                        <canvas id="ventasChart"></canvas>
                    </div>
                </div>

                <div class="col-12 col-lg-6">
                    <div class="table-container">
                        <h5>Top 10 Productos M√°s Vendidos</h5>
                        {% if productos_top %}
                        <table class="table top-productos-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-end d-none d-sm-table-cell">Cantidad</th>
                                    <th class="text-end">Ingresos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prod in productos_top %}
                                <tr>
                                    <td><strong>{{ prod.producto__nombre }}</strong></td>
                                    <td class="text-end d-none d-sm-table-cell">
                                        <span class="badge-success">{{ prod.total }}</span>
                                    </td>
                                    <td class="text-end"><strong>${{ prod.ingresos|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="empty-state">
                            <p>No hay datos de ventas a√∫n</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- MEJOR MARGEN Y REPONER STOCK -->
            <div class="row">
                <div class="col-12 col-lg-6 mb-4 mb-lg-0">
                    <div class="table-container">
                        <h5>Productos con Mejor Margen</h5>
                        {% if productos_margen %}
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-end d-none d-md-table-cell">Costo</th>
                                    <th class="text-end d-none d-md-table-cell">Venta</th>
                                    <th class="text-end">Ganancia</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prod in productos_margen %}
                                <tr>
                                    <td><strong>{{ prod.nombre|truncatewords:3 }}</strong></td>
                                    <td class="text-end d-none d-md-table-cell">${{ prod.precio_compra }}</td>
                                    <td class="text-end d-none d-md-table-cell">${{ prod.precio_venta }}</td>
                                    <td class="text-end">
                                        <span class="badge-success">${{ prod.ganancia_unitaria|floatformat:2 }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="empty-state">
                            <p>No hay productos registrados</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-12 col-lg-6">
                    <div class="table-container">
                        <h5>Productos a Reponer</h5>
                        {% if productos_reponer %}
                        <table class="table reponer-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-end">Stock Actual</th>
                                    <th class="text-end d-none d-sm-table-cell">M√≠nimo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prod in productos_reponer %}
                                <tr>
                                    <td><strong>{{ prod.nombre|truncatewords:3 }}</strong></td>
                                    <td class="text-end">
                                        <span class="badge-alert">{{ prod.stock_actual }}</span>
                                    </td>
                                    <td class="text-end d-none d-sm-table-cell">{{ prod.stock_minimo }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="empty-state">
                            <p>Todo el inventario est√° en orden</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- BOT√ìN FLOTANTE CHATBOT -->
        <a href="{% url 'chatbot:chatbot' %}" class="chatbot-button" style="text-decoration: none;">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            </svg>
        </a>

        {% block js_scripts %}
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                // Gr√°fico de ventas
                const ctx = document.getElementById('ventasChart');
                const chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: {{ labels_semana|safe }},
                        datasets: [{
                            label: 'Ventas ($)',
                            data: {{ datos_semana|safe }},
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        animation: {
                            duration: 2000,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#667eea',
                                borderWidth: 1,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(2);
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                // Hacer chartInstance global para que dashboard.js pueda accederlo
                window.chartInstance = chartInstance;
            </script>
            <script src="{% static 'companies/js/dashboard.js' %}"></script>
        {% endblock js_scripts %}
    </body>
{% endblock content %}